<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- This tag is essential for mobile-friendly design -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import the Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        /* A little extra style for better visual feedback */
        .btn-primary {
            @apply w-full text-white p-3 rounded-lg font-semibold transition-transform transform hover:scale-105;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <!-- 
      Key Changes for Responsiveness:
      - w-full: Takes up the full width on small screens.
      - max-w-md: Limits the maximum width on larger screens (desktops) to keep the form readable.
      - p-6 sm:p-8: Uses slightly less padding on very small screens.
    -->
    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-md">
        <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-center text-gray-800">BSE Bot Login</h1>
        
        <!-- Area for success/error messages -->
        <div id="message-area" class="mb-4 text-sm"></div>

        <!-- Sign in with Google Button -->
        <button id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg hover:bg-gray-50 flex items-center justify-center mb-4 font-semibold transition-colors opacity-50 cursor-not-allowed" disabled>
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo" class="w-5 h-5 mr-3">
            Sign in with Google
        </button>

        <!-- "OR" divider -->
        <div class="relative flex py-3 items-center">
            <div class="flex-grow border-t border-gray-200"></div>
            <span class="flex-shrink mx-4 text-gray-400 text-xs uppercase">OR</span>
            <div class="flex-grow border-t border-gray-200"></div>
        </div>

        <!-- Step 1: Enter Phone Number -->
        <div id="phone-entry">
            <input id="phone-number" type="tel" placeholder="+91 12345 67890" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <div id="recaptcha-container"></div>
            <button id="send-otp-btn" class="btn-primary bg-blue-500 hover:bg-blue-600 opacity-50 cursor-not-allowed" disabled>Sign in with Phone</button>
        </div>

        <!-- Step 2: Enter OTP -->
        <div id="otp-entry" class="hidden">
            <p class="text-center text-gray-600 mb-2">Enter the OTP sent to your phone.</p>
            <input id="otp-code" type="text" placeholder="Enter OTP" class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-center tracking-widest text-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
            <button id="verify-otp-btn" class="btn-primary bg-green-500 hover:bg-green-600">Verify & Login</button>
        </div>
    </div>

    <script>
        // --- SECURE: Load Firebase config from backend ---
        let firebaseApp = null;
        let auth = null;
        
        // Initialize Firebase when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });
        
        async function initializeFirebase() {
            try {
                showMessage('Loading...', 'blue');
                
                // Fetch Firebase configuration from backend
                const response = await fetch('/firebase-config');
                const firebaseConfig = await response.json();
                
                if (!response.ok || firebaseConfig.error) {
                    throw new Error(firebaseConfig.error || 'Failed to load Firebase configuration');
                }
                
                // Initialize Firebase with the loaded config
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                
                // Setup reCAPTCHA verifier for phone auth
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible'
                });
                
                // Enable login buttons after Firebase is initialized
                enableLoginButtons();
                clearMessage();
                
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                showMessage(`Firebase initialization failed: ${error.message}`, 'red');
                // Disable login buttons if Firebase fails to initialize
                disableLoginButtons();
            }
        }
        
        function enableLoginButtons() {
            const googleLoginBtn = document.getElementById('google-login-btn');
            const sendOtpBtn = document.getElementById('send-otp-btn');
            
            googleLoginBtn.disabled = false;
            sendOtpBtn.disabled = false;
            googleLoginBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            sendOtpBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        function disableLoginButtons() {
            const googleLoginBtn = document.getElementById('google-login-btn');
            const sendOtpBtn = document.getElementById('send-otp-btn');
            
            googleLoginBtn.disabled = true;
            sendOtpBtn.disabled = true;
            googleLoginBtn.classList.add('opacity-50', 'cursor-not-allowed');
            sendOtpBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
        
        function clearMessage() {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = '';
        }
        // Get DOM elements
        const googleLoginBtn = document.getElementById('google-login-btn');
        const phoneEntryDiv = document.getElementById('phone-entry');
        const otpEntryDiv = document.getElementById('otp-entry');
        const phoneNumberInput = document.getElementById('phone-number');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const otpCodeInput = document.getElementById('otp-code');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const messageArea = document.getElementById('message-area');

        // --- Google Login Logic ---
        googleLoginBtn.addEventListener('click', () => {
            if (!auth) {
                showMessage('Firebase not initialized. Please refresh the page.', 'red');
                return;
            }
            
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('email');
            provider.addScope('profile');
            auth.signInWithPopup(provider)
                .then((result) => result.user.getIdToken())
                .then((idToken) => sendTokenToBackend(idToken, '/verify_google_token'))
                .catch((error) => showMessage(`Error: ${error.message}`, 'red'));
        });

        // --- Phone Login Logic ---
        sendOtpBtn.addEventListener('click', () => {
            if (!auth) {
                showMessage('Firebase not initialized. Please refresh the page.', 'red');
                return;
            }
            
            const phoneNumber = phoneNumberInput.value;
            if (!phoneNumber) {
                showMessage('Please enter a phone number.', 'red');
                return;
            }
            const appVerifier = window.recaptchaVerifier;
            
            auth.signInWithPhoneNumber(phoneNumber, appVerifier)
                .then((confirmationResult) => {
                    window.confirmationResult = confirmationResult;
                    showMessage('OTP sent successfully!', 'green');
                    // Hide other login options and show OTP entry
                    phoneEntryDiv.classList.add('hidden');
                    googleLoginBtn.classList.add('hidden');
                    document.querySelector('.relative.flex').classList.add('hidden');
                    otpEntryDiv.classList.remove('hidden');
                }).catch((error) => {
                    showMessage(`Error: ${error.message}`, 'red');
                    // Reset reCAPTCHA on error
                    if (typeof grecaptcha !== 'undefined') {
                        recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                    }
                });
        });

        verifyOtpBtn.addEventListener('click', () => {
            const code = otpCodeInput.value;
            if (!code) {
                showMessage('Please enter the OTP.', 'red');
                return;
            }
            confirmationResult.confirm(code)
                .then((result) => result.user.getIdToken())
                .then((idToken) => sendTokenToBackend(idToken, '/verify_phone_token'))
                .catch((error) => showMessage(`Error: ${error.message}`, 'red'));
        });

        // --- Backend Communication ---
        function sendTokenToBackend(idToken, endpoint) {
            showMessage('Verifying...', 'blue');
            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: idToken })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Login successful! Redirecting...', 'green');
                    // Redirect to dashboard on success
                    window.location.href = "/"; 
                } else {
                    throw new Error(data.error || 'Backend verification failed.');
                }
            })
            .catch(error => showMessage(`Error: ${error.message}`, 'red'));
        }

        // --- UI Helper ---
        function showMessage(msg, color) {
            const colorClasses = {
                red: 'bg-red-100 text-red-700',
                green: 'bg-green-100 text-green-700',
                blue: 'bg-blue-100 text-blue-700'
            };
            messageArea.innerHTML = `<div class="${colorClasses[color]} p-3 rounded-lg">${msg}</div>`;
        }
    </script>
</body>
</html>
