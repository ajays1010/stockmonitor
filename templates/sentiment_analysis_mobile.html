<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üìä Sentiment Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media (max-width: 640px) {
            .sentiment-card { margin: 8px 0; }
            .tap-target { min-height: 44px; min-width: 44px; }
        }
        .sentiment-positive { border-left: 4px solid #10b981; background: #ecfdf5; }
        .sentiment-negative { border-left: 4px solid #ef4444; background: #fef2f2; }
        .sentiment-neutral { border-left: 4px solid #6b7280; background: #f9fafb; }
        .sentiment-pending { border-left: 4px solid #f59e0b; background: #fffbeb; }
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
            <h1 class="text-2xl font-bold text-gray-800">üì∞ News & Sentiment Analysis</h1>
            <div class="flex gap-2">
                <button onclick="refreshSentiment()" class="bg-blue-500 text-white py-2 px-3 rounded hover:bg-blue-600 tap-target">
                    üîÑ Refresh
                </button>
                <a href="/" class="bg-gray-500 text-white py-2 px-3 rounded hover:bg-gray-600 tap-target">
                    ‚Üê Dashboard
                </a>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8 loading" style="display: none;">
            <div class="text-gray-600">üìà Loading sentiment data...</div>
        </div>

        <!-- Sentiment Summary Cards -->
        <div id="sentimentCards" class="space-y-4">
            <!-- Cards will be populated here -->
        </div>

        <!-- Individual Stock Analysis -->
        <div class="mt-8">
            <h2 class="text-xl font-bold mb-4">üéØ Analyze Individual Stock</h2>
            <div class="bg-white p-4 rounded-lg shadow">
                <select id="stockSelect" class="w-full p-3 border rounded mb-3 tap-target">
                    <option value="">Select a stock...</option>
                    {% for scrip in scrips %}
                    <option value="{{ scrip.bse_code }}" data-company="{{ scrip.company_name }}">
                        {{ scrip.company_name }} ({{ scrip.bse_code }})
                    </option>
                    {% endfor %}
                </select>
                <button onclick="analyzeStock()" class="w-full bg-blue-500 text-white py-3 rounded hover:bg-blue-600 tap-target">
                    üìä Detailed Sentiment Analysis
                </button>
                <p class="text-xs text-gray-500 mt-2 text-center">Opens comprehensive analysis with real-time news</p>
            </div>
        </div>
    </div>

    <script>
        let userData = { scrips: [] };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSentimentSummary();
            loadSentimentPreferences();
        });

        async function loadSentimentSummary() {
            document.getElementById('loadingState').style.display = 'block';
            
            try {
                const response = await fetch('/get_sentiment_summary');
                const data = await response.json();
                
                if (data.success) {
                    displaySentimentCards(data.summary_data);
                } else {
                    showError('Failed to load sentiment data: ' + data.error);
                }
            } catch (error) {
                showError('Error loading sentiment data: ' + error.message);
            }
            
            document.getElementById('loadingState').style.display = 'none';
        }

        async function loadSentimentPreferences() {
            try {
                const response = await fetch('/get_sentiment_preferences');
                const data = await response.json();
                
                if (data.success) {
                    userData.preferences = data.preferences;
                }
            } catch (error) {
                console.error('Error loading preferences:', error);
            }
        }

        function displaySentimentCards(summaryData) {
            const container = document.getElementById('sentimentCards');
            
            if (!summaryData || summaryData.length === 0) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <div class="text-gray-500">
                            üì∞ No news monitoring data yet.<br>
                            <small>News monitoring runs every 30 minutes. Use "Detailed Sentiment Analysis" below to analyze any stock on-demand.</small>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = summaryData.map(stock => {
                const isEnabled = userData.preferences?.[stock.company_name]?.enabled ?? true;
                const hasNews = stock.overall_sentiment === 'NEWS_AVAILABLE';
                
                return `
                    <div class="bg-white rounded-lg shadow sentiment-neutral news-card">
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold text-lg">${stock.company_name}</h3>
                                    <p class="text-sm text-gray-600">${stock.bse_code}</p>
                                </div>
                                <button onclick="toggleSentiment('${stock.company_name}', ${!isEnabled})" 
                                        class="tap-target px-3 py-1 rounded text-sm ${isEnabled ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-700'}">
                                    ${isEnabled ? '‚úÖ ON' : '‚ùå OFF'}
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 mt-3">
                                <div>
                                    <div class="text-2xl mb-1">${hasNews ? 'üì∞' : '‚è≥'} ${hasNews ? 'News Available' : 'Monitoring'}</div>
                                    <div class="text-sm text-gray-600">${hasNews ? 'Ready for analysis' : 'Waiting for news'}</div>
                                </div>
                                <div class="text-right">
                                    <button onclick="analyzeIndividualStock('${stock.bse_code}', '${stock.company_name}')" 
                                            class="bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600 tap-target">
                                        üìä Analyze
                                    </button>
                                </div>
                            </div>
                            
                            ${stock.has_data ? `
                                <div class="mt-3 text-xs text-gray-500">
                                    Last news update: ${new Date(stock.last_analysis).toLocaleString()}<br>
                                    Click "Analyze" above for detailed sentiment analysis
                                </div>
                            ` : `
                                <div class="mt-3 text-xs text-gray-500">
                                    ‚è≥ Monitoring for news updates every 30 minutes...
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function toggleSentiment(stockName, enabled) {
            try {
                const response = await fetch('/toggle_sentiment_preference', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_name: stockName, enabled: enabled })
                });
                
                const data = await response.json();
                if (data.success) {
                    // Update local data and refresh display
                    if (!userData.preferences) userData.preferences = {};
                    if (!userData.preferences[stockName]) userData.preferences[stockName] = {};
                    userData.preferences[stockName].enabled = enabled;
                    
                    loadSentimentSummary(); // Refresh display
                } else {
                    showError('Failed to update preference: ' + data.error);
                }
            } catch (error) {
                showError('Error updating preference: ' + error.message);
            }
        }

        async function analyzeStock() {
            const stockSelect = document.getElementById('stockSelect');
            
            if (!stockSelect.value) {
                alert('Please select a stock first.');
                return;
            }

            const stockSymbol = stockSelect.value;
            const companyName = stockSelect.options[stockSelect.selectedIndex].dataset.company;
            
            // Navigate to detailed analysis page
            const params = new URLSearchParams({
                symbol: stockSymbol,
                name: companyName
            });
            
            window.location.href = `/sentiment_analysis_detailed?${params.toString()}`;
        }
        
        function analyzeIndividualStock(stockSymbol, companyName) {
            // Navigate to detailed analysis page from card button
            const params = new URLSearchParams({
                symbol: stockSymbol,
                name: companyName
            });
            
            window.location.href = `/sentiment_analysis_detailed?${params.toString()}`;
        }

        function refreshSentiment() {
            loadSentimentSummary();
        }

        function getSentimentClass(sentiment) {
            switch(sentiment) {
                case 'POSITIVE': return 'sentiment-positive';
                case 'NEGATIVE': return 'sentiment-negative';
                case 'PENDING': return 'sentiment-pending';
                default: return 'sentiment-neutral';
            }
        }

        function getSentimentEmoji(sentiment) {
            switch(sentiment) {
                case 'POSITIVE': return 'üìà';
                case 'NEGATIVE': return 'üìâ';
                case 'PENDING': return '‚è≥';
                default: return 'üìä';
            }
        }

        function showError(message) {
            const container = document.getElementById('sentimentCards');
            container.innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    ‚ùå ${message}
                </div>
            `;
        }
    </script>
</body>
</html>