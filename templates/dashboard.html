<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-8">
        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-3 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Your Dashboard</h1>
            <div class="flex gap-3">
                <a href="/sentiment_analysis_mobile" class="bg-indigo-500 text-white py-2 px-4 rounded hover:bg-indigo-600">ðŸ“Š Enhanced Sentiment Analysis</a>
                <a href="/logout" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">Logout</a>
            </div>
        </div>
        <p class="mb-6 text-gray-600">Logged in as: <strong>{{ (user_email if not user_email.endswith('@yourapp.com') else user_phone) }}</strong></p>
        
        {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
        <div class="mb-4">
            {% for category, msg in messages %}
            <div class="p-3 rounded mb-2 {% if category == 'success' %}bg-green-100 text-green-800{% elif category == 'error' %}bg-red-100 text-red-800{% elif category == 'warning' %}bg-yellow-100 text-yellow-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                {{ msg }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Monitor New Scrip</h2>
                <!-- This is the new search box that provides suggestions -->
                <div class="relative mb-6">
                    <!-- On small screens, make the search full-width and bump tap targets -->
                    <style>
                        @media (max-width: 640px) {
                            #search-box { font-size: 16px; padding: 12px 14px; }
                            #search-results div { padding: 12px 10px; }
                        }
                    </style>
                    <input type="text" id="search-box" placeholder="Search by name or BSE code..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" autocomplete="off">
                    <div id="search-results" class="absolute z-10 w-full bg-white border mt-1 rounded-lg shadow-lg hidden"></div>
                </div>
                <h3 class="text-lg font-semibold mb-4 border-t pt-4">Your Monitored Scrips</h3>
                
                <!-- Send Script Messages Button -->
                {% if monitored_scrips and telegram_recipients %}
                <div class="mb-4 space-y-2">
                    <form action="/send_script_messages" method="post" class="inline-block">
                        <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            ðŸ“Š Send Script Messages to Telegram
                        </button>
                    </form>
                    <p class="text-sm text-gray-600">Get current prices/MA and last X hours BSE announcements for your monitored scrips</p>
                </div>
                {% elif monitored_scrips %}
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Add your Telegram ID to receive script updates</p>
                </div>
                {% elif telegram_recipients %}
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Add some scrips to monitor and get updates</p>
                </div>
                {% else %}
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Add scrips and Telegram ID to get started</p>
                </div>
                {% endif %}
                
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full bg-white">
                        <tbody>
                            {% for scrip in monitored_scrips %}
                            <tr class="border-b">
                                <td class="py-2 px-4"><b>{{ scrip.bse_code }}</b><br><span class="text-sm text-gray-600">{{ scrip.company_name }}</span></td>
                                <td class="py-2 px-4 text-right">
                                    <form action="/delete_scrip" method="post" class="inline-block">
                                        <input type="hidden" name="scrip_code" value="{{ scrip.bse_code }}">
                                        <button type="submit" class="bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Announcement Categories</h2>
                <form action="/set_category_prefs" method="post" class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-sm text-gray-600">Choose which categories to receive</div>
                        <div class="space-x-2">
                            <button type="button" id="select-all-cats" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-2 rounded">Select all</button>
                            <button type="button" id="select-none-cats" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-2 rounded">Select none</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        {% set all_cats = ['financials','rating','investor_presentation','Board Meeting','Happening'] %}
                        {% for c in all_cats %}
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="categories" value="{{ c }}" class="mr-2" {% if c in category_prefs %}checked{% endif %}>
                            {{ c }}
                        </label>
                        {% endfor %}
                    </div>
                    <div id="cats-none-warning" class="mt-2 text-xs text-yellow-700 bg-yellow-50 border border-yellow-200 rounded p-2 hidden">
                        Warning: With no categories selected, you will not receive any announcements.
                    </div>
                    <button type="submit" class="mt-3 bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded">Save</button>
                </form>

                <script>
                    (function() {
                        const allBtn = document.getElementById('select-all-cats');
                        const noneBtn = document.getElementById('select-none-cats');
                        const warn = document.getElementById('cats-none-warning');
                        const checkboxes = () => Array.from(document.querySelectorAll('input[type="checkbox"][name="categories"]'));

                        function updateWarning() {
                            const anyChecked = checkboxes().some(cb => cb.checked);
                            if (!anyChecked) warn.classList.remove('hidden'); else warn.classList.add('hidden');
                        }

                        allBtn?.addEventListener('click', () => {
                            checkboxes().forEach(cb => cb.checked = true);
                            updateWarning();
                        });
                        noneBtn?.addEventListener('click', () => {
                            checkboxes().forEach(cb => cb.checked = false);
                            updateWarning();
                        });
                        // Also update when users toggle manually
                        checkboxes().forEach(cb => cb.addEventListener('change', updateWarning));
                        // Initial state
                        updateWarning();
                    })();
                </script>

                <h2 class="text-xl font-semibold mb-4">Add Your Telegram Recipient</h2>
                <form action="/add_recipient" method="post" class="space-y-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="chat_id" placeholder="Enter Telegram Chat ID" class="shadow border rounded py-2 px-3" required>
                        <input type="text" name="user_name" placeholder="Enter Recipient Name (e.g., John, Family)" class="shadow border rounded py-2 px-3" required>
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full md:w-auto">Add Recipient</button>
                    <p class="text-sm text-gray-600">Multiple users can now share the same chat ID with different names</p>
                </form>
                <h3 class="text-lg font-semibold mb-4 border-t pt-4">Your Telegram Recipients</h3>
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr class="border-b">
                                <th class="py-2 px-4 text-left">Recipient Name</th>
                                <th class="py-2 px-4 text-left">Chat ID</th>
                                <th class="py-2 px-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for recipient in telegram_recipients %}
                            <tr class="border-b">
                                <td class="py-2 px-4 font-medium">ðŸ‘¤ {{ recipient.user_name or 'Unknown' }}</td>
                                <td class="py-2 px-4 text-gray-600">{{ recipient.chat_id }}</td>
                                <td class="py-2 px-4 text-right">
                                    <form action="/delete_recipient" method="post" class="inline-block">
                                        <input type="hidden" name="chat_id" value="{{ recipient.chat_id }}">
                                        <input type="hidden" name="user_name" value="{{ recipient.user_name }}">
                                        <button type="submit" class="bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

       <!-- Big full-width row for BSE Announcements at the end -->
       {% if monitored_scrips and telegram_recipients %}
       <div class="bg-white p-6 rounded-lg shadow-lg mt-8">
           <h2 class="text-2xl font-bold mb-4">ðŸ“° BSE Announcements</h2>
           <form action="/send_bse_announcements" method="post" class="flex flex-wrap items-center gap-3">
               <label for="hours_back_bottom" class="text-sm text-gray-700">Last</label>
               <select name="hours_back" id="hours_back_bottom" class="border rounded px-2 py-1 text-sm">
                   <option value="6">6h</option>
                   <option value="12">12h</option>
                   <option value="24" selected>24h</option>
                   <option value="48">48h</option>
                   <option value="72">72h</option>
               </select>
               <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded">Send Announcements</button>
               <p class="text-sm text-gray-600">Sends a consolidated summary and PDFs for new announcements.</p>
           </form>
       </div>
       {% endif %}
       

    </div>

    <!-- This JavaScript powers the fuzzy search suggestions -->
    <script>
        const searchBox = document.getElementById('search-box');
        const searchResults = document.getElementById('search-results');
        let debounceTimer;

        searchBox.addEventListener('keyup', () => {
            clearTimeout(debounceTimer);
            const query = searchBox.value;
            if (query.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }
            debounceTimer = setTimeout(() => {
                fetch(`/search?query=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        searchResults.innerHTML = '';
                        if (data.matches && data.matches.length > 0) {
                            data.matches.forEach(match => {
                                const div = document.createElement('div');
                                div.innerHTML = `<div class="p-3 hover:bg-gray-100 cursor-pointer"><p class="font-bold">${match['Company Name']} <span class="font-normal text-gray-600">(${match['BSE Code']})</span></p></div>`;
                                div.addEventListener('click', () => addScrip(match['BSE Code'], match['Company Name']));
                                searchResults.appendChild(div);
                            });
                            searchResults.classList.remove('hidden');
                        } else {
                            searchResults.innerHTML = `<div class="p-3 text-gray-500">No matches found.</div>`;
                        }
                    });
            }, 300);
        });

        function addScrip(bseCode, companyName) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/add_scrip';
            
            const codeInput = document.createElement('input');
            codeInput.type = 'hidden';
            codeInput.name = 'scrip_code';
            codeInput.value = bseCode;
            form.appendChild(codeInput);

            const nameInput = document.createElement('input');
            nameInput.type = 'hidden';
            nameInput.name = 'company_name';
            nameInput.value = companyName;
            form.appendChild(nameInput);

            document.body.appendChild(form);
            form.submit();
        }

        document.addEventListener('click', e => {
            if (!searchBox.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
